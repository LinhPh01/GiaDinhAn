import{t as x}from"../../external/@swc/helpers/src/_async_to_generator.mjs.js.ae57f58a.js";import{R,s as J}from"../../constants.js.e7b682ef.js";import{u as S}from"../../utils/lodash.js.932cc367.js";import{p as z,u as B,f as y}from"../eventEmitter.js.34c69e49.js";import{m as G,O as Z,l as K,p as Q,b as V}from"../../utils/common.js.81cce464.js";import{A as j}from"../token.js.34b36f63.js";import{c as D}from"../utils.js.d402a870.js";import{m as W}from"../apis/general/getSetting.js.1064f1cc.js";import{s as X}from"../../appEnv/getEnv.js.8915b352.js";import{e as Y}from"../../external/tslib/tslib.es6.js.20b0ea63.js";import{o as oo}from"../../types/enum.js.5367e09a.js";var P,F,u,g,H,v,mo=(u=X(),g={},H=z.getInstance(),v=[],B(function(a){var s=a.serialId,e=G(a.result),o=Z(e==null?void 0:e.action),m=S.isEmpty(e==null?void 0:e.error_code)?0:e==null?void 0:e.error_code,T=e==null?void 0:e.error_message,i=(e==null?void 0:e.data)||e;if(o&&m===0){var r=JSON.parse(e==null?void 0:e.data);m=S.isEmpty(r==null?void 0:r.error_code)?0:r==null?void 0:r.error_code,T=r==null?void 0:r.error_message,i=(r==null?void 0:r.data)||r}var t={error_code:m,error_message:T,data:i,action:(e==null?void 0:e.action)||a.actionName};if(s&&g[s]){var n=g[s],k=n.callback,f=n.timeout,U=n.isMultiCallback,l=n.options;(function(p,C){var _=C||{},b=_.success,E=_.fail;p.error_code===0?S.isFunction(b)&&b(p):S.isFunction(E)&&E(p)})(t,k),!U&&delete g[s],f&&clearTimeout(f);var d={action:t==null?void 0:t.action,error:t==null?void 0:t.error_code,message:t==null?void 0:t.error_message,data:{}};try{if(t.action==="action.open.inapp"||t.action==="action.open.outapp"){var I=new URL(l==null?void 0:l.url),h="".concat(I.protocol,"//").concat(I.host).concat(I.pathname);d.data={url:h}}if(t.action==="action.follow.oa"||t.action==="action.unfollow.oa"){var w=l==null?void 0:l.uid;d.data={uid:w}}if(t.action==="action.open.chat"){var M=l==null?void 0:l.uId,N=l==null?void 0:l.type;d.data={uid:M,openChatType:N}}}catch{}v.push(d)}}),H.on(oo.AppPaused,function(){if(v.length>0){var a=v;v=[],D(a)}}),P?clearInterval(P):P=setInterval(function(){if(v.length>0){var a=v;v=[],D(a)}},5e3),F=x(function(a,s,e,o){var m,T,i,r,t,n,k,f,U,l,d,I,h,w,M,N,p,C,_,b,E,A,O,$,L;return Y(this,function(c){switch(c.label){case 0:return T=Math.floor(1e6*Math.random()),i="".concat(a,"_").concat(T),r="action.".concat(a.replace(/\_/g,".").toLowerCase()),(o==null?void 0:o.actionName)&&o.actionName.length>0&&(r=o==null?void 0:o.actionName),t=(o==null?void 0:o.isMultiCallback)||!1,n=(o==null?void 0:o.timeout)!==!1&&((o==null?void 0:o.timeout)||!0),k=(o==null?void 0:o.haveCallback)||!1,f=(o==null?void 0:o.skipJump)||!1,U=(o==null?void 0:o.requireAccessToken)||!1,l=V(r),s&&e&&(g[i]={options:s,callback:e,isMultiCallback:t},n&&k&&(g[i].timeout=setTimeout(function(){var q={serialId:i,result:{error_code:R.TIME_OUT,error_message:J.TIME_OUT,data:{timeout:n},action:a}};return y(q),null},n===!0?8e3:1e3*n))),l?[4,W()]:[3,2];case 1:if(((I=c.sent())==null||(d=I.authSetting)===null||d===void 0?void 0:d["scope.userInfo"])===!1)return w={serialId:i,result:{error_code:R.UNAUTHORIZED,error_message:J.NEED_USER_AUTH,data:{isMobile:u==null||(h=u.platform)===null||h===void 0?void 0:h.isMobile},action:a}},y(w),[2];c.label=2;case 2:return M=Z(r),!(!(u==null||(m=u.platform)===null||m===void 0)&&m.isMobile)||!a||S.isUndefined(ZaloJavaScriptInterface)||u.platform.isIOS&&!K(a)||M&&M.isSupported===!1?(p={serialId:i,result:{error_code:R.CLIENT_NOT_SUPPORT,error_message:J.CLIENT_NOT_SUPPORT,data:{isMobile:u==null||(N=u.platform)===null||N===void 0?void 0:N.isMobile},action:a}},y(p),[2]):(C=Q(s),f?[3,4]:[4,j.getJSAccessToken()]);case 3:return b=c.sent(),[3,5];case 4:b="",c.label=5;case 5:_=b,c.label=6;case 6:return c.trys.push([6,10,,11]),f||!U?[3,8]:[4,j.getAccessToken()];case 7:return A=c.sent(),[3,9];case 8:A="",c.label=9;case 9:return E=A,[3,11];case 10:return O=c.sent(),$={serialId:i,result:{error_code:O==null?void 0:O.code,error_message:O==null?void 0:O.message,action:a}},y($),[2];case 11:return L=u.platform.isIOS?window.onNativeMessage(i,r):'window.onNativeMessage("'.concat(i,'", "').concat(r,'")'),[2,ZaloJavaScriptInterface.jsCall(_,r,E,C,L)]}})}),function(a,s,e,o){return F.apply(this,arguments)});export{mo as E};
