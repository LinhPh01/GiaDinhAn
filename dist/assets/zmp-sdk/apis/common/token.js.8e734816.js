import{t as g}from"../external/@swc/helpers/src/_async_to_generator.mjs.js.ae57f58a.js";import{a as I}from"../external/@swc/helpers/src/_class_call_check.mjs.js.fca3aa24.js";import{r as C}from"../external/@swc/helpers/src/_create_class.mjs.js.dbee51ee.js";import{t as b}from"../external/@swc/helpers/src/_object_spread.mjs.js.864104b0.js";import{u as S}from"../utils/lodash.js.932cc367.js";import{E as y,N as _,o as w,T as E,a as N,i as P}from"../constants.js.9c557f4a.js";import{e as U}from"./logger.js.1ff5fb47.js";import{E as G}from"./call/zaloNative.js.76ac03e6.js";import{o as A}from"../utils/response.js.7db2e312.js";import{c as v}from"./utils.js.15775276.js";import{O}from"../utils/common.js.6eb930ef.js";import{r as J}from"./apis/general/authorize.js.be653e9b.js";import{m as $}from"./apis/general/getSetting.js.15d678cf.js";import{e as p}from"../external/tslib/tslib.es6.js.20b0ea63.js";import{a as k}from"../types/enum.js.df3937d6.js";var D=function(){function h(){I(this,h),this._jumpStatus=void 0,this.WAITING_QUEUE=[],this.getAccessTokenCount=0,this._accessToken="",this._jsAccessToken="",this.refreshToken="",this._cookies=[],this.accessTokenExpiresIn=0,this.prevGetAccessTokenTimestamp=new Date().getTime(),this.manualSetAccessToken=!1,this._miniProgramConfig={}}var d=h.prototype;return d.jump=function(){var s=this;return g(function(){return p(this,function(e){return[2,new Promise(function(o,n){s._jumpStatus?s._jumpStatus===k.DONE?o(k.DONE):o(k.DOING):(s._jumpStatus=k.DOING,U({stage:y.REQUEST,type:"log",name:"jump"}),G("JUMP_LOGIN",{},{success:function(t){var a=t.data;s._miniProgramConfig=(a==null?void 0:a.miniProgramConfig)||{};var c=(a==null?void 0:a.cookiesOAuthLogins)||[],r=c.find(function(i){return i.name===_.JS_TOKEN});r&&(s._jsAccessToken=r.value,window.ZJSBridge.setJSToken&&window.ZJSBridge.setJSToken(r.value)),s._cookies=c;var l=s._cookies.find(function(i){return i.name===_.ZOAUTH});l!=null&&l.value||v([{action:"action.jump.login",error:-102,message:"no zoauth",data:{}}]),o(k.DONE)},fail:function(t){v([{action:"action.jump.login",error:-101,message:t.message||"jump error",data:{}}]),n(t)}},{skipJump:!0}))})]})})()},d.loginZaloV3=function(s,e,o){var n=this;return g(function(){var t;return p(this,function(a){switch(a.label){case 0:return t="".concat(w.GET_ACCESS_TOKEN_V3,"?app_id=").concat(e,"&redirect_uri=").concat(P,"/").concat(s,"/&code=").concat(o,"&isSDK=true"),[4,fetch(t).then((c=g(function(r){var l,i,u;return p(this,function(f){switch(f.label){case 0:return[4,r.json()];case 1:return l=f.sent(),i=l==null?void 0:l.access_token,n._accessToken=i,u=1e3*parseInt(l.expires_in),n.accessTokenExpiresIn=u,n.prevGetAccessTokenTimestamp=new Date().getTime(),window.ZJSBridge.setZAccSession&&window.ZJSBridge.setZAccSession(n._accessToken||""),[2,i]}})}),function(r){return c.apply(this,arguments)}))];case 1:return[2,a.sent()]}var c})})()},d.loginZaloV4=function(s){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"",n=this;return g(function(){var t,a;return p(this,function(c){switch(c.label){case 0:return(t=new URLSearchParams).append("app_id",s),t.append("code",e),t.append("code_verifier",o),S.isNull(n.refreshToken)||n.refreshToken.length===0?t.append("grant_type","authorization_code"):(t.append("grant_type","refresh_token"),t.append("refresh_token",n.refreshToken||"")),a={headers:{"Content-Type":"application/x-www-form-urlencoded"}},[4,fetch(w.GET_ACCESS_TOKEN,b({method:"POST",body:t},a)).then((r=g(function(l){var i,u,f,T;return p(this,function(m){switch(m.label){case 0:return[4,l.json()];case 1:return i=m.sent(),u=(i==null?void 0:i.access_token)||"",f=(i==null?void 0:i.refresh_token)||"",n.refreshToken=f,n._accessToken=u,T=1e3*parseInt(i==null?void 0:i.expires_in),n.accessTokenExpiresIn=T,n.prevGetAccessTokenTimestamp=new Date().getTime(),window.ZJSBridge.setZAccSession&&window.ZJSBridge.setZAccSession(u),[2,u]}})}),function(l){return r.apply(this,arguments)}))];case 1:return[2,c.sent()]}var r})})()},d.getAccessToken=function(){var s=arguments.length>0&&arguments[0]!==void 0&&arguments[0],e=this;return g(function(){var o,n,t,a,c,r,l,i,u;function f(){return T.apply(this,arguments)}function T(){return(T=g(function(){return p(this,function(m){switch(m.label){case 0:return[4,new Promise(function(j){var Z=setInterval(function(){(t.getAccessTokenCount<=1||t._accessToken)&&(j("done"),clearInterval(Z))},200)})];case 1:return[2,m.sent()]}})})).apply(this,arguments)}return p(this,function(m){switch(m.label){case 0:return n=new Date().getTime()-e.prevGetAccessTokenTimestamp,(t=e).getAccessTokenCount++,e.getAccessTokenCount>1?[4,f()]:[3,2];case 1:m.sent(),m.label=2;case 2:return e.manualSetAccessToken||e._accessToken.length>0&&n<e.accessTokenExpiresIn&&((o=e._miniProgramConfig)===null||o===void 0?void 0:o.userAuthorized)?(t.getAccessTokenCount--,[2,Promise.resolve(e._accessToken)]):(e.accessToken="",[4,e.jumpAndGetToken(_.ZOAUTH)]);case 3:return a=m.sent(),[4,e.jumpAndGetToken(_.ZOAUTH_VRF)];case 4:return c=m.sent(),r="zmp.getaccesstoken.fail",s?[4,e.verifyUserAuthorized()]:[3,6];case 5:return l=m.sent(),[3,7];case 6:l=!0,m.label=7;case 7:if(!l)throw t.getAccessTokenCount--,v([{action:r,error:-104,message:"no user auth",data:{}}]),A.error.loginFailed("User Authentication Required");if(!a)return[3,15];m.label=8;case 8:return m.trys.push([8,13,,14]),c?[4,e.loginZaloV4(E,a,c)]:[3,10];case 9:return i=m.sent(),[3,12];case 10:return[4,e.loginZaloV3(E,N,a)];case 11:i=m.sent(),m.label=12;case 12:return[3,14];case 13:return u=m.sent(),i="",console.log("Can not get access token",u),v([{action:r,error:-103,message:String(u)||"Can not get access token",data:{}}]),[3,14];case 14:return t.getAccessTokenCount--,i?[2,Promise.resolve(e._accessToken)]:(v([{action:r,error:-101,message:"no accessToken",data:{}}]),[2,Promise.reject(A.error.loginFailed("Can't get accessToken. Please try again later."))]);case 15:throw t.getAccessTokenCount--,v([{action:r,error:-102,message:"no oauth",data:{}}]),A.error.loginFailed("Zalo app has not been activated")}})})()},d.verifyUserAuthorized=function(){var s=this;return g(function(){var e,o,n,t,a,c;return p(this,function(r){switch(r.label){case 0:if(o=!0,((e=s._miniProgramConfig)===null||e===void 0?void 0:e.userAuthorized)!==!1)return[3,6];r.label=1;case 1:return r.trys.push([1,5,,6]),(n=O("action.mp.user.authorize"))&&n.isSupported?[4,$()]:[3,4];case 2:return((a=r.sent())==null||(t=a.authSetting)===null||t===void 0?void 0:t["scope.userInfo"])!==!1?[3,4]:[4,J()];case 3:c=r.sent(),o=(c==null?void 0:c["scope.userInfo"])||!1,r.label=4;case 4:return[3,6];case 5:return r.sent(),o=!1,[3,6];case 6:return[2,o]}})})()},d.setAccessToken=function(s){this.manualSetAccessToken=!0,this._accessToken=s,window.ZJSBridge.setZAccSession&&window.ZJSBridge.setZAccSession(s)},d.getJSAccessToken=function(){var s=this;return g(function(){var e;return p(this,function(o){switch(o.label){case 0:return s._jsAccessToken.length>0?[2,Promise.resolve(s._jsAccessToken)]:[4,s.jumpAndGetToken(_.JS_TOKEN)];case 1:return e=o.sent(),[2,Promise.resolve(e)]}})})()},d.getSync=function(s){var e;return(e=this._cookies.find(function(o){return o.name===s}))===null||e===void 0?void 0:e.value},d.jumpAndGetToken=function(s){var e,o=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=this;return new Promise((e=g(function(t){var a,c,r,l;return p(this,function(i){switch(i.label){case 0:return!o&&n._cookies.length>0?S.isString(s)?(a=n._cookies.find(function(u){return u.name===s}),[2,t(a==null?void 0:a.value)]):[2,t("")]:(o&&n._jumpStatus===k.DONE&&(n._jumpStatus=void 0),c={name:s,cb:function(u){return t(u)}},[4,n.jump()]);case 1:return(r=i.sent())===k.DONE?(n._jumpStatus=r,n.WAITING_QUEUE.length&&(n.WAITING_QUEUE.forEach(function(u){var f=n._cookies.find(function(T){return T.name===u.name});u.cb(f==null?void 0:f.value)}),n.WAITING_QUEUE=[]),l=n._cookies.find(function(u){return u.name===c.name}),c.cb(l==null?void 0:l.value)):n.WAITING_QUEUE.push(c),[2]}})}),function(t){return e.apply(this,arguments)}))},h.getInstance=function(){return h.instance||(h.instance=new h),h.instance},C(h,[{key:"jumpStatus",get:function(){return this._jumpStatus}},{key:"accessToken",set:function(s){this._accessToken=s,window.ZJSBridge.setZAccSession&&window.ZJSBridge.setZAccSession(s)}},{key:"miniProgramConfig",get:function(){return this._miniProgramConfig}}]),h}(),ee=D.getInstance();export{ee as A};
